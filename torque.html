<!DOCTYPE html>
<html>
<head>
    <title>Google Maps JavaScript API v3 Example: Map Coordinates</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.15/themes/css/cartodb.css" />

    <meta charset="UTF-8">
    <style>
        @import url(vendor/leaflet.css);
        html, body 	{
            width: 100%;
            height: 100%;
            border: 0;
            padding: 0;
            margin: 0;
            overflow:hidden;
        }
        #map {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 0;
            padding: 0;
            margin: 0;
            background: white;
        }
        #time_slider {
            position: absolute;
            bottom: 20px;
            left: 40px;
            width: 800px;
            height: 45px;
        }
        #play {
            position: absolute;
            bottom: 20px;
            right: 40px;
            width: 50px;
            height: 45px;
        }

        #clock{
          margin-top:20px;
        }


    </style>

<script id="choropleth" type="text/cartocss">
#google_flash {
  polygon-fill: torque({categories}, {colors});
  // polygon-fill: 'green';
  polygon-opacity: 0.6;
  line-color: white;
  line-width: 0.2;
  line-opacity: 1;
  transition-time: 300;
}



</script>

</head>
<body>
<h1 id='title'></h1>
<div id="map">
</div>
<div id='legend'></div>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="vendor/d3.v3.js" charset="utf-8"></script>

  <script src="vendor/underscore-min.js"></script>
  <script src="vendor/carto.uncompressed.js"></script>
  <script src="d3.jsonp.js"></script>
  <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script>
  <script src="d3_cartodb_layer.js"></script>


  <script>


  function vis(step, min, torque_settings, categories) {
    var layers;
    var selectedLayer = 0;
    var layer = new cartodb.d3.Layer({
        user: torque_settings.user
    })
    var steps = torque_settings.steps
    var geom_tables ={
      states:{
        table: "us_states_detailed",
        join_col: "state_name"
      },
      dma:{
        table: "dma_boundary",
        join_col: "dma_1"
      },
      county:{
        table : "cb_2014_us_county_20m",
        join_col: "countyfp"
      }
    }

    var geom = geom_tables[torque_settings.geom_type];
    console.log("STETINGS " ,torque_settings)

    var base = cartodb.createLayer(map, 'https://basemaps01.cartodb.com/api/v2/viz/1453eb5e-6b7e-11e5-888a-0ea31932ec1d/viz.json').addTo(map)
    layer.addTo(map);
    var labels = cartodb.createLayer(map, 'https://basemaps01.cartodb.com/api/v2/viz/383b3aae-6b88-11e5-8720-0e787de82d45/viz.json').addTo(map)

    // base.setZIndex(0)
    // layer.setZIndex(3)
    // labels.setZIndex(2)

    layer.setGlobal('step', min);

query = ["            WITH par AS (",
"                  select min(date_part('epoch',{time_col})) as start_d, max(date_part('epoch',{time_col})) as end_d, ",
"                     (max(date_part('epoch',{time_col})) - min(date_part('epoch',{time_col})))/{steps} as step_size from {user}.{table}",
"                ),",
"                deco AS (",
"                  SELECT row_number() OVER() cat, {type_col} FROM {user}.{table} GROUP BY {type_col}",
"                )",
"                SELECT g.the_geom, g.the_geom_webmercator, g.{join_col},",
"                       array_agg(deco.cat ORDER BY d) vals__uint8,",
"                       array_agg(d*step_size + start_d ORDER BY d) dates__uint16",
"                FROM (",
"                    SELECT",
"                        i.{type_col} {type_col},",
"                        floor((date_part('epoch',{time_col}) - start_d)/step_size) d,",
"                        i.{join_col_input}",
"                    FROM (SELECT * FROM {user}.{table}) i, par p",
"                    GROUP BY i.{time_col}, d, p.start_d, i.{type_col}, i.{join_col_input}",
"                ) cte, par, (SELECT the_geom, the_geom_webmercator, {join_col} FROM {user}.{join_table}) g, deco",
"                WHERE cte.{type_col} = deco.{type_col} AND g.{join_col} = cte.{join_col_input}",
"                GROUP BY g.the_geom, g.the_geom_webmercator, g.{join_col}"].join('');

    query = query.formatWithObj({user: torque_settings.user,
                                table: torque_settings.table,
                                time_col:torque_settings.time,
                                type_col: torque_settings.type,
                                steps: torque_settings.steps,
                                join_table: geom.table,
                                join_col: geom.join_col,
                                join_col_input: torque_settings.join_col_input})
    console.log("query", query)

    layer.setSQL(query)
    var cartocss  = document.getElementById('choropleth').innerHTML

    cartocss =cartocss.formatWithObj({colors: torque_settings.colors, categories:Object.keys(categories) })

    console.log(cartocss)
    layer.setCartoCSS(cartocss);


    var updateStep = function(stepNo,min){
      var d  = stepNo*step + min
      layer.setGlobal('step', d);
      var date = new Date(d*1000)
      $("#clock").html(date.toString().split("GMT")[0] )
    }


    function play(){
      var val=0;
      maxTime = steps;
      setInterval(function(){
         if(val >= maxTime ){
           val = 0
         }
         val += 1
         updateStep(val,min)
      },torque_settings.duration*1000.0/torque_settings.steps)
    }

    play();
  }
  var map;
  function start() {



    var torque_settings = {
      user : 'andrew',
      table : 'cb_results',
      intensity : 'i',
      duration: 30,
      time : 'date',
      type : 'most_searched',
      title: '',
      // geom_type : "states",
      geom_type : "county",
      steps : 256
    }

    var search = location.search.substring(1);
    if (search){
      var url_settings  = JSON.parse('{"' + decodeURI(search).replace(/"/g, '\\"').replace(/&/g, '","').replace(/=/g,'":"') + '"}')


      url_settings.colors = []
      Object.keys(url_settings).filter(function(key){return key.indexOf('col_') == 0})
                               .forEach(function(key){
                                 var index = parseInt(key.replace('col_',''));
                                 url_settings.colors[index] = url_settings[key]
                                 delete url_settings[key]
                               })


      Object.keys(url_settings).forEach(function(key){
        torque_settings[key] = url_settings[key]
      })
    }





    var c = [13.624633438236152, -2.63671875]
    map = new L.Map("map", {center: c, zoom: 4})


    // cartodb.createLayer(map, 'https://team.cartodb.com/u/stuartlynn/api/v2/viz/1da0b98e-5e19-11e5-a27d-0e43f3deba5a/viz.json')
    // .addTo(map)
//
//     L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
//     attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
// }).addTo(map);

    function createLegend(torque_settings,categories){

      var data = categories.map(function(cat,index){
        return {name: cat, value: torque_settings.colors[index-1]}
      })

      var categoryLegend = new cartodb.geo.ui.Legend.Category({
          title: decodeURIComponent(torque_settings.title),
          data:data.slice(1,data.length)
      });

      $("#legend").append(categoryLegend.render().$el);

      $("#legend .cartodb-legend").append("<div id='clock'></div>")
    }

    function getCategories(torque_settings, callback){
      var url = 'https://{0}.cartodb.com/api/v2/sql'.format(torque_settings.user)
      var query = "SELECT row_number() OVER() cat, {type} FROM {user}.{table} GROUP BY {type}".formatWithObj(torque_settings)

      $.ajax({
          url: url+'?q='+encodeURIComponent(query),
          jsonp: "callback",
          dataType: "jsonp",
          success: function( res ) {
            var categories = []
            res.rows.forEach(function(cat){
              categories[cat.cat] = cat[torque_settings.type]
            })
            callback(categories)
          }
      })
    }

    var url = 'https://{0}.cartodb.com/api/v2/sql'.format(torque_settings.user)
    $.ajax({
        url: url+'?q='+encodeURIComponent("select min(date_part('epoch', {0})) min, max(date_part('epoch', {0})) max, count(distinct({0})) as distinct from {1}".format(torque_settings.time, torque_settings.table)),
        jsonp: "callback",
        dataType: "jsonp",
        success: function( res ) {
          getCategories(torque_settings,function(categories){


            if(torque_settings.steps=='auto'){
              torque_settings.steps = Math.min(res.rows[0].distinct,256)
            }

            createLegend(torque_settings,categories)
            // createLegend(torque_settings,categories);

            var step = (res.rows[0]['max'] - res.rows[0]['min'])/torque_settings.steps;
            var min = res.rows[0]['min'];

            vis(step, min, torque_settings, categories);
          })
        }
      });
  }

  window.onload = start;


  String.prototype.formatWithObj = (function () {
        function format() {

            var str = this,
                args = arguments[0]

            Object.keys(args).forEach(function(key){
              safe = typeof args[key]== 'object' ? JSON.stringify(args[key]) : args[key];
              str = str.replace(RegExp('\\{' + key + '\\}', 'g'), safe);
            })
            return str;
        }
      return format;
    })();

    String.prototype.format = (function (i, safe, arg) {
          function format() {
              var str = this,
                  len = arguments.length + 1;

              for (i = 0; i < len; arg = arguments[i++]) {
                  safe = typeof arg === 'object' ? JSON.stringify(arg) : arg;
                  str = str.replace(RegExp('\\{' + (i - 1) + '\\}', 'g'), safe);
              }
              return str;
          }

          //format.native = String.prototype.format;
          return format;
      })();
  </script>
</body>
</html>
